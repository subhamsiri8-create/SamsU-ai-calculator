<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediCode Pro Suite</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            --accent-cpt: #7c3aed;
            --accent-icd: #059669;
            --danger: #ef4444;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* --- APP HEADER --- */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .theme-toggle { background: none; border: none; font-size: 1.5rem; color: var(--text-sec); cursor: pointer; }

        /* --- NAVIGATION --- */
        nav {
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 20;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-sec);
            background: none;
            border: none;
            cursor: pointer;
            gap: 4px;
        }
        .nav-item i { font-size: 1.5rem; }
        .nav-item.active { color: var(--primary); font-weight: 600; }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Space for nav */
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .view { display: none; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SEARCH BAR --- */
        .search-wrapper {
            position: sticky;
            top: 0;
            background: var(--bg);
            padding-bottom: 15px;
            z-index: 5;
        }
        .search-input {
            width: 100%;
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            outline: none;
        }
        .search-input:focus { border-color: var(--primary); ring: 2px solid var(--primary); }

        /* --- CARDS --- */
        .code-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            position: relative;
            transition: transform 0.1s;
        }
        .code-card:active { transform: scale(0.98); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .badge { 
            padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; font-family: monospace; 
        }
        .icd { background: rgba(5, 150, 105, 0.1); color: var(--accent-icd); }
        .cpt { background: rgba(124, 58, 237, 0.1); color: var(--accent-cpt); }
        
        .action-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-sec); cursor: pointer; padding: 4px; }
        .action-btn.starred { color: #eab308; } /* Yellow Star */
        
        .card-desc { font-weight: 500; margin-bottom: 4px; line-height: 1.4; }
        .card-meta { font-size: 0.8rem; color: var(--text-sec); }

        /* --- DECODER --- */
        .decoder-input {
            width: 100%;
            text-align: center;
            font-size: 2rem;
            padding: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 20px;
            border: 2px dashed var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 12px;
        }
        .blocks { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .block { background: var(--surface); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .block strong { display: block; font-size: 1.2rem; color: var(--primary); }
        .block span { font-size: 0.7rem; color: var(--text-sec); text-transform: uppercase; }

        /* --- ADD NEW FORM --- */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: var(--text-sec); }
        .form-control { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text); }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-outline { width: 100%; padding: 15px; background: transparent; border: 2px solid var(--border); color: var(--text); border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }

    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="ph ph-first-aid"></i> MediCode Pro</div>
        <button class="theme-toggle" onclick="toggleTheme()"><i class="ph ph-moon"></i></button>
    </header>

    <main>
        <div id="view-search" class="view active">
            <div class="search-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="Search codes, diseases, CPT..." onkeyup="handleSearch()">
            </div>
            <div id="resultsList"></div>
        </div>

        <div id="view-saved" class="view">
            <h2><i class="ph ph-star-fill" style="color:#eab308"></i> My Favorites</h2>
            <p style="color:var(--text-sec); font-size:0.9rem;">Your personal collection of codes.</p>
            <div id="savedList"></div>
            <button class="btn-outline" onclick="exportData()"><i class="ph ph-download-simple"></i> Export to CSV</button>
        </div>

        <div id="view-decoder" class="view">
            <h2>Code Breaker</h2>
            <p style="color:var(--text-sec)">Visualize the structure of ICD-10 codes.</p>
            <input type="text" id="decoderInput" class="decoder-input" placeholder="S52501A" maxlength="8" onkeyup="decodeCode()">
            <div id="decoderBlocks" class="blocks"></div>
            <p id="decoderText" style="text-align:center; margin-top:20px; color:var(--text-sec); font-style:italic;"></p>
        </div>

        <div id="view-add" class="view">
            <h2>Add Custom Code</h2>
            <div class="form-group">
                <label class="form-label">Code (ICD-10 or CPT)</label>
                <input type="text" id="newCode" class="form-control" placeholder="e.g. Z99.9">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="newDesc" class="form-control" placeholder="e.g. Dependence on unspecified machine">
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select id="newType" class="form-control">
                    <option value="ICD-10">ICD-10 (Diagnosis)</option>
                    <option value="CPT">CPT (Procedure)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="addCustomCode()">Save to Database</button>
        </div>
    </main>

    <nav>
        <button class="nav-item active" onclick="switchView('search', this)">
            <i class="ph ph-magnifying-glass"></i> Search
        </button>
        <button class="nav-item" onclick="switchView('saved', this)">
            <i class="ph ph-bookmarks"></i> Saved
        </button>
        <button class="nav-item" onclick="switchView('decoder', this)">
            <i class="ph ph-magic-wand"></i> Decoder
        </button>
        <button class="nav-item" onclick="switchView('add', this)">
            <i class="ph ph-plus-circle"></i> Add
        </button>
    </nav>

<script>
    // --- DATABASE INITIALIZATION ---
    // A larger starter set of common codes
    const defaultData = [
        { id: 1, code: "I10", type: "ICD-10", desc: "Essential (primary) hypertension", cat: "Cardio" },
        { id: 2, code: "E11.9", type: "ICD-10", desc: "Type 2 diabetes mellitus without complications", cat: "Endo" },
        { id: 3, code: "99213", type: "CPT", desc: "Office visit, established patient (20-29 min)", cat: "E&M" },
        { id: 4, code: "99214", type: "CPT", desc: "Office visit, established patient (30-39 min)", cat: "E&M" },
        { id: 5, code: "J01.90", type: "ICD-10", desc: "Acute sinusitis, unspecified", cat: "Resp" },
        { id: 6, code: "M54.5", type: "ICD-10", desc: "Low back pain", cat: "Ortho" },
        { id: 7, code: "Z00.00", type: "ICD-10", desc: "General adult medical exam w/o abnormal findings", cat: "Admin" },
        { id: 8, code: "U07.1", type: "ICD-10", desc: "COVID-19", cat: "Viral" },
        { id: 9, code: "73030", type: "CPT", desc: "X-ray of shoulder, minimum of 2 views", cat: "Rad" },
        { id: 10, code: "F41.1", type: "ICD-10", desc: "Generalized anxiety disorder", cat: "Psych" },
        { id: 11, code: "R05", type: "ICD-10", desc: "Cough", cat: "Symp" },
        { id: 12, code: "R50.9", type: "ICD-10", desc: "Fever, unspecified", cat: "Symp" }
    ];

    // Load Data from LocalStorage or use Default
    let db = JSON.parse(localStorage.getItem('medicode_db')) || defaultData;
    let savedIds = JSON.parse(localStorage.getItem('medicode_saved')) || [];

    // --- RENDER FUNCTIONS ---
    function renderList(data, containerId, isSavedView = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sec)">No codes found.</div>`;
            return;
        }

        data.forEach(item => {
            const isSaved = savedIds.includes(item.id);
            // If we are in "Saved View" and item isn't saved, skip it
            if (isSavedView && !isSaved) return;

            const html = `
                <div class="code-card">
                    <div class="card-header">
                        <span class="badge ${item.type === 'CPT' ? 'cpt' : 'icd'}">${item.code}</span>
                        <div>
                            <button class="action-btn" onclick="copyToClipboard('${item.code}')"><i class="ph ph-copy"></i></button>
                            <button class="action-btn ${isSaved ? 'starred' : ''}" onclick="toggleSave(${item.id})">
                                <i class="ph ${isSaved ? 'ph-star-fill' : 'ph-star'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-desc">${item.desc}</div>
                    <div class="card-meta">${item.type} â€¢ ${item.cat}</div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // --- LOGIC: SEARCH & SAVE ---
    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = db.filter(item => 
            item.code.toLowerCase().includes(query) || 
            item.desc.toLowerCase().includes(query)
        );
        renderList(filtered, 'resultsList');
    }

    function toggleSave(id) {
        if (savedIds.includes(id)) {
            savedIds = savedIds.filter(sid => sid !== id); // Remove
        } else {
            savedIds.push(id); // Add
        }
        localStorage.setItem('medicode_saved', JSON.stringify(savedIds));
        
        // Refresh views
        handleSearch(); 
        renderList(db, 'savedList', true);
    }

    function addCustomCode() {
        const code = document.getElementById('newCode').value;
        const desc = document.getElementById('newDesc').value;
        const type = document.getElementById('newType').value;

        if (!code || !desc) return alert("Please fill in fields");

        const newItem = {
            id: Date.now(), // Generate unique ID based on time
            code: code.toUpperCase(),
            desc: desc,
            type: type,
            cat: "Custom"
        };

        db.unshift(newItem); // Add to top of list
        localStorage.setItem('medicode_db', JSON.stringify(db)); // Save to persistence
        
        alert("Code Added!");
        // Reset form
        document.getElementById('newCode').value = '';
        document.getElementById('newDesc').value = '';
        
        // Go to search
        switchView('search', document.querySelectorAll('.nav-item')[0]);
        handleSearch();
    }

    // --- UTILS: EXPORT & COPY ---
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        alert(`Copied: ${text}`);
    }

    function exportData() {
        const savedItems = db.filter(item => savedIds.includes(item.id));
        if (savedItems.length === 0) return alert("No favorites to export.");

        let csvContent = "data:text/csv;charset=utf-8,Code,Description,Type\n";
        savedItems.forEach(item => {
            csvContent += `${item.code},"${item.desc}",${item.type}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "my_medical_codes.csv");
        document.body.appendChild(link);
        link.click();
    }

    // --- DECODER LOGIC ---
    function decodeCode() {
        const code = document.getElementById('decoderInput').value.toUpperCase().replace('.','');
        const blocks = document.getElementById('decoderBlocks');
        const text = document.getElementById('decoderText');
        blocks.innerHTML = '';
        text.innerText = '';

        if(code.length < 3) return;

        // Visual logic for ICD-10
        const p1 = code.substring(0,3); // Category
        const p2 = code.substring(3,6); // Etiology
        const p3 = code.substring(6,7); // Extension

        blocks.innerHTML += `<div class="block"><strong>${p1}</strong><span>Category</span></div>`;
        
        if (code.length > 3) {
            blocks.innerHTML += `<div class="block"><strong>${p2}</strong><span>Detail/Site</span></div>`;
        }
        if (code.length > 6) {
            blocks.innerHTML += `<div class="block" style="border-color:var(--primary)"><strong>${p3}</strong><span>Encounter</span></div>`;
            if (p3 === 'A') text.innerText = "Initial Encounter: Active treatment phase.";
            if (p3 === 'D') text.innerText = "Subsequent Encounter: Recovery/Healing phase.";
            if (p3 === 'S') text.innerText = "Sequela: Complications arising after healing.";
        }
    }

    // --- APP NAVIGATION ---
    function switchView(viewName, btnElement) {
        // Hide all views
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (btnElement) btnElement.classList.add('active');

        // Special render for saved list
        if (viewName === 'saved') renderList(db, 'savedList', true);
    }

    // --- THEME ---
    function toggleTheme() {
        const current = document.body.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
    }

    // Init
    handleSearch();

</script>
</body>
</html>
